---
import { getRepository, getReleases } from "../utils/github";

// Server-side code goes here
const timestamp = new Date().toISOString();

// Example repository (replace with your own)
const owner = "mrfylke";
const repo = "kontraktsportal-api";

// Fetch repository and release data
const [repository, releases] = await Promise.all([
  getRepository(owner, repo),
  getReleases(owner, repo),
]);

// Calculate hours since last release
let hoursSinceLastRelease = null;
if (releases.length > 0) {
  const lastReleaseDate = new Date(releases[0].published_at);
  const now = new Date();
  const diffMs = now.getTime() - lastReleaseDate.getTime();
  hoursSinceLastRelease = Math.floor(diffMs / (1000 * 60 * 60));
}

// Check if there is a draft release
const hasDraftRelease = releases.some((release) => release.draft);

// Enable static generation with ISR revalidation
export const prerender = true;
export const config = {
  isr: {
    revalidate: 300, // 5 minutes in seconds
  },
};
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{repository.full_name} - GitHub Stats</title>
  </head>
  <body>
    <main>
      <h1>{repository.full_name}</h1>
      <p>{repository.description}</p>

      <div class="release-info">
        <div>
          ‚è∞ Hours since last release: {
            hoursSinceLastRelease !== null ? hoursSinceLastRelease : "N/A"
          }
        </div>
        <div>üìù Draft release present: {hasDraftRelease ? "Yes" : "No"}</div>
      </div>

      <p class="timestamp">Last updated: {timestamp}</p>
    </main>
  </body>
</html>

<style>
  body {
    font-family:
      system-ui,
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      Roboto,
      sans-serif;
    line-height: 1.6;
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }

  .release-info {
    margin: 2rem 0;
    padding: 1rem;
    background: #e8f0fe;
    border-radius: 8px;
    display: flex;
    gap: 2rem;
    font-size: 1.1rem;
  }

  .timestamp {
    margin-top: 2rem;
    color: #666;
    font-size: 0.9rem;
  }
</style>
